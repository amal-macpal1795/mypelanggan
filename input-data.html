<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Input Data Pelanggan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #fafafa;
      display: flex;
      justify-content: center;
      padding: 20px;
    }
    .container {
      width: 100%;
      max-width: 500px;
      position: relative;
    }
    h1 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      text-align: center;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      padding: 20px;
    }
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #222;
    }
    .form-group {
      margin-bottom: 14px;
    }
    label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      display: block;
      margin-bottom: 6px;
    }
    input, select, textarea {
      width: 95%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
      outline: none;
      transition: border 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #4f46e5;
    }
    .divider {
      border-top: 1px solid #e5e5e5;
      margin: 20px 0;
    }
    .submit-btn {
      width: 100%;
      padding: 14px;
      background: #8119b5;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .submit-btn:hover {
      background: #550a7a;
    }
    .success {
      color: green;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }
    .error {
      color: red;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }
    .scan-btn {
      width: 100%;
      padding: 14px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 10px;
    }
    .scan-btn:hover {
      background: #0056b3;
    }

    /* CSS untuk Tampilan Kamera Layar Penuh */
    .camera-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: none;
      background-color: black;
      z-index: 100;
    }
    #camera-view {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .ktp-frame {
      width: 90%;
      max-width: 400px;
      aspect-ratio: 1.586 / 1;
      border: 2px solid white;
      box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
      border-radius: 10px;
      position: relative;
    }

    /* Kotak Patokan OCR */
    .ocr-region {
        position: absolute;
        border: 1px dashed rgba(255, 255, 255, 0.7);
        box-sizing: border-box;
    }
    /* Posisi berdasarkan pengukuran dari user */
    .nik-frame {
        left: 23.36%;
        top: 14.82%;
        width: 47.43%;
        height: 9.26%;
    }
    .nama-frame {
        left: 23.36%;
        top: 24.08%;
        width: 47.43%;
        height: 11.08%;
    }

    #camera-capture-btn {
      position: fixed;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      width: 70px;
      height: 70px;
      background-color: white;
      border-radius: 50%;
      border: 5px solid rgba(255, 255, 255, 0.5);
      cursor: pointer;
      z-index: 101;
      display: none;
    }
    #ocr-status-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 15px;
      border-radius: 10px;
      font-style: italic;
      z-index: 102;
      display: none;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Input Data Pelanggan</h1>
    <div class="card">
      <form id="pelangganForm">
        <button type="button" id="scanKtpBtn" class="scan-btn">Pindai KTP</button>
        <div id="ocr-status"></div>

        <div class="divider"></div>
        <div class="section-title">Info Pelanggan</div>
        <div class="form-group">
          <label for="tanggal_pasang">Tanggal Pemasangan</label>
          <input type="date" id="tanggal_pasang" required>
        </div>
        <div class="form-group">
          <label for="nik">NIK</label>
          <input type="text" id="nik" required>
        </div>
        <div class="form-group">
          <label for="nama_lengkap">Nama Lengkap</label>
          <input type="text" id="nama_lengkap" required>
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email">
        </div>
        
        <div class="form-group">
          <label for="hp_wa">Nomor Handphone (WA/SMS)</label>
          <input type="tel" id="hp_wa">
        </div>
        <div class="form-group">
          <label for="hp_dial">Nomor Handphone (Dial Phone)</label>
          <input type="tel" id="hp_dial">
        </div>
        <div class="form-group">
          <label for="kota">Kota</label>
          <select id="kota">
            <option value="" disabled selected>Pilih kota...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="cluster">Perumahan/Cluster/Apartment</label>
          <select id="cluster">
            <option value="" disabled selected>Pilih cluster...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="homepass">Homepass</label>
          <input type="text" id="homepass">
        </div>
        <div class="form-group">
          <label for="alamat">Alamat Pemasangan</label>
          <textarea id="alamat" rows="3"></textarea>
        </div>
        <div class="divider"></div>
        <div class="section-title">Info Produk</div>
        <div class="form-group">
          <label for="paket_internet">Paket Internet</label>
          <select id="paket_internet">
            <option>(107) Jet20 Mbps</option>
            <option>(146) Plus Value30 Mbps</option>
            <option>(108) Value30 Mbps</option>
            <option>(109) Fast50 Mbps</option>
            <option>(127) Nova100 Mbps Reg</option>
            <option>(133) MyGamers250 Mbps</option>
            <option>(138) Prime500 Mbps</option>
          </select>
        </div>
        <div class="form-group">
          <label for="paket_tv">Paket TV</label>
          <select id="paket_tv">
            <option>Tanpa paket TV</option>
            <option>Basic TV</option>
            <option>Premium TV</option>
          </select>
        </div>
        <div class="form-group">
          <label for="addon">Add On</label>
          <input type="text" id="addon" placeholder="Pisahkan dengan koma jika lebih dari satu">
        </div>
        <div class="form-group">
          <label for="metode_bayar">Metode Pembayaran</label>
          <select id="metode_bayar">
            <option>Tunai Bulanan</option>
            <option>Kartu Kredit (Auto Debit)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="promo">Promo</label>
          <input type="checkbox" id="promo"> Ikut Promo
        </div>
        <button type="submit" class="submit-btn">Simpan Data</button>
        <div class="success" id="success"></div>
        <div class="error" id="error"></div>
      </form>
    </div>
  </div>

  <div id="camera-container" class="camera-container">
    <video id="camera-view" autoplay playsinline></video>
    <div class="camera-overlay">
      <div class="ktp-frame">
        <div class="ocr-region nik-frame"></div>
        <div class="ocr-region nama-frame"></div>
      </div>
    </div>
    <button id="camera-capture-btn" class="scan-btn">Ambil Foto</button>
    <canvas id="camera-canvas" style="display:none;"></canvas>
    <div id="ocr-status-overlay"></div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
  <script>
    const supabaseUrl = "https://jewyknkcquolyguipxhr.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impld3lrbmtjcXVvbHlndWlweGhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNjA2MzQsImV4cCI6MjA3MzczNjYzNH0.WX8a-wqR5mtKrULGcmd2JrgsDktM-wBYTT7zpC-v6Vw";
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    // Elemen HTML untuk OCR
    const scanKtpBtn = document.getElementById('scanKtpBtn');
    const cameraContainer = document.getElementById('camera-container');
    const video = document.getElementById('camera-view');
    const captureBtn = document.getElementById('camera-capture-btn');
    const canvas = document.getElementById('camera-canvas');
    const ocrStatus = document.getElementById('ocr-status');
    const ocrStatusOverlay = document.getElementById('ocr-status-overlay');
    const nikInput = document.getElementById('nik');
    const namaLengkapInput = document.getElementById('nama_lengkap');
    const alamatInput = document.getElementById('alamat');
    const ktpFrame = document.querySelector('.ktp-frame');
    let stream;
    
    // Fungsi untuk membuka kamera
    async function openCamera() {
      try {
        ocrStatus.textContent = 'Meminta akses kamera...';
        cameraContainer.style.display = 'block';
        video.srcObject = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 }, 
            height: { ideal: 720 }
          }
        });
        captureBtn.style.display = 'block';
        ocrStatus.textContent = '';
      } catch (err) {
        ocrStatus.textContent = 'Gagal mengakses kamera. Pastikan Anda memberikan izin.';
        console.error('Error accessing camera:', err);
        cameraContainer.style.display = 'none';
      }
    }

    // Fungsi untuk mengambil foto dan memproses OCR
    async function captureAndRecognize() {
        video.pause();
        captureBtn.style.display = 'none';
        
        const context = canvas.getContext('2d');
        const ocrWidth = 800;
        const ocrHeight = video.videoHeight * (ocrWidth / video.videoWidth);
        
        canvas.width = ocrWidth;
        canvas.height = ocrHeight;
        context.drawImage(video, 0, 0, ocrWidth, ocrHeight);
        
        // Hentikan stream kamera
        video.srcObject.getTracks().forEach(track => track.stop());
        cameraContainer.style.display = 'none';
        
        ocrStatus.textContent = 'Menganalisis teks dari foto... Mohon tunggu.';
        ocrStatusOverlay.textContent = 'Menganalisis teks dari foto...';
        ocrStatusOverlay.style.display = 'block';
        
        try {
            // Logika pemindaian dua tahap
            // Tahap 1: Pindai seluruh gambar untuk menemukan posisi kata kunci "NIK" dan "Nama"
            const { data: { words } } = await Tesseract.recognize(canvas, 'ind', {
                logger: m => console.log('Tahap 1 scan status:', m.status)
            });

            // Temukan kata kunci
            let nikKeyword = words.find(w => w.text.toUpperCase().includes('NIK'));
            let namaKeyword = words.find(w => w.text.toUpperCase().includes('NAMA'));

            if (!nikKeyword || !namaKeyword) {
                ocrStatusOverlay.style.display = 'none';
                ocrStatus.textContent = 'Kata kunci NIK atau Nama tidak ditemukan. Coba foto ulang.';
                return;
            }

            // Tahap 2: Pindai area spesifik di sebelah kanan kata kunci
            const nikRegion = {
                left: nikKeyword.bbox.x1, // Mulai dari ujung kanan kata "NIK"
                top: nikKeyword.bbox.y0,
                width: ocrWidth - nikKeyword.bbox.x1, // Sampai ujung kanan gambar
                height: nikKeyword.bbox.y1 - nikKeyword.bbox.y0
            };

            const namaRegion = {
                left: namaKeyword.bbox.x1,
                top: namaKeyword.bbox.y0,
                width: ocrWidth - namaKeyword.bbox.x1,
                height: namaKeyword.bbox.y1 - namaKeyword.bbox.y0
            };
            
            // Pindai area NIK
            const { data: { text: nikText } } = await Tesseract.recognize(canvas, 'ind', {
                logger: m => console.log('Tahap 2 NIK scan status:', m.status),
                rectangle: nikRegion
            });

            // Pindai area Nama
            const { data: { text: namaText } } = await Tesseract.recognize(canvas, 'ind', {
                logger: m => console.log('Tahap 2 Nama scan status:', m.status),
                rectangle: namaRegion
            });

            ocrStatusOverlay.style.display = 'none';

            if (nikText) {
                const cleanNik = nikText.replace(/[^0-9]/g, '');
                if (cleanNik.length === 16) {
                    nikInput.value = cleanNik;
                }
            }
            if (namaText) {
                namaLengkapInput.value = namaText.trim().toUpperCase();
            }

            ocrStatus.textContent = 'Pemindaian selesai. Harap periksa kembali data!';
            
            cameraContainer.style.display = 'none';
        } catch (ocrError) {
            ocrStatusOverlay.style.display = 'none';
            ocrStatus.textContent = 'Terjadi kesalahan saat memproses OCR.';
            console.error('OCR Error:', ocrError);
        }
    }

    scanKtpBtn.addEventListener('click', openCamera);
    captureBtn.addEventListener('click', captureAndRecognize);

    // ... (Sisa kode loadKota, loadCluster, dan submit form Anda)
    async function loadKota() {
      const { data, error } = await client.from("kota").select("id,nama");
      if (error) { console.error("Error loading kota:", error.message); return; }
      const kotaSelect = document.getElementById("kota");
      kotaSelect.innerHTML = '<option value="" disabled selected>Pilih kota...</option>';
      data.forEach(k => {
        const opt = document.createElement("option");
        opt.value = k.id;
        opt.textContent = k.nama;
        kotaSelect.appendChild(opt);
      });
    }

    document.getElementById("kota").addEventListener("change", async (e) => {
      const kotaId = e.target.value;
      const { data, error } = await client.from("cluster").select("id,nama").eq("kota_id", kotaId);
      const clusterSelect = document.getElementById("cluster");
      clusterSelect.innerHTML = '<option value="" disabled selected>Pilih cluster...</option>';
      if (error) { console.error("Error loading cluster:", error.message); return; }
      data.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.nama;
        clusterSelect.appendChild(opt);
      });
    });

    loadKota();

    document.getElementById("pelangganForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const successDiv = document.getElementById("success");
      const errorDiv = document.getElementById("error");
      successDiv.textContent = "";
      errorDiv.textContent = "";

      const { data: getUser, error: authError } = await client.auth.getUser();
      if (authError || !getUser.user) {
        errorDiv.textContent = "Anda harus login terlebih dahulu!";
        console.error("Authentication error:", authError);
        return;
      }
      
      const payload = {
        tanggal: document.getElementById("tanggal_pasang").value,
        nik: document.getElementById("nik").value,
        nama_lengkap: document.getElementById("nama_lengkap").value,
        email: document.getElementById("email").value,
        hp_wa: document.getElementById("hp_wa").value,
        hp_dial: document.getElementById("hp_dial").value,
        kota_id: document.getElementById("kota").value,
        cluster_id: document.getElementById("cluster").value,
        homepass: document.getElementById("homepass").value,
        alamat: document.getElementById("alamat").value,
        paket_internet: document.getElementById("paket_internet").value,
        paket_tv: document.getElementById("paket_tv").value,
        addon: document.getElementById("addon").value.split(",").map(x => x.trim()).filter(Boolean),
        metode_pembayaran: document.getElementById("metode_bayar").value,
        promo: document.getElementById("promo").checked,
        sales_id: getUser.user.id
      };
      
      const { error } = await client.from("pelanggan").insert([payload]);
      if (error) {
        console.error(error);
        errorDiv.textContent = "Gagal menyimpan: " + error.message;
      } else {
        window.location.replace("dashboard.html");
      }
    });
  </script>
</body>
</html>
