<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title id="page-title">Input Data Pelanggan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/b6fe4d3ab8.js" crossorigin="anonymous"></script>
  <style>
    /* ... Semua CSS dari sebelumnya tetap sama ... */
    body { margin:0; font-family:'Poppins',sans-serif; background:#fafafa; display:flex; justify-content:center; padding:20px; }
    .container { width:100%; max-width:500px; }
    h1 { font-size:22px; font-weight:600; margin-bottom:20px; color:#333; text-align:center; }
    .card { /* Dibiarkan kosong */ }
    .section-title { font-size:16px; font-weight:600; margin-bottom:12px; color:#222; }
    .form-group { margin-bottom:14px; }
    label { font-size:13px; font-weight:500; color:#333; display:block; margin-bottom:6px; }
    input, select, textarea { width:100%; padding:12px; border-radius:10px; border:1px solid #ddd; font-size:13px; font-family:'Poppins',sans-serif; outline:none; transition:border 0.2s; box-sizing: border-box; }
    .nik-input { font-family: 'OCR A Extended', 'SF Mono', 'Courier New', monospace; font-weight: 600; letter-spacing: 1.5px; font-size: 15px; }
    .uppercase-input { text-transform: uppercase; }
    input:focus, select:focus, textarea:focus { border-color:#8119b5; }
    .divider { border-top:1px solid #e5e5e5; margin:20px 0; }
    .submit-btn { width:100%; padding:14px; background:#8119b5; color:#fff; border:none; border-radius:12px; font-size:15px; font-weight:500; cursor:pointer; transition:background 0.2s; }
    .submit-btn:hover { background: #550a7a; }
    .success, .error { font-size:14px; margin-top:10px; text-align:center; }
    .success { color:green; }
    .error { color:red; }
    .validation-error { color: #d92d20; font-size: 11px; font-weight: 500; margin-top: 4px; display: none; }
    #map { height: 300px; width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid #ddd; }
    .locate-btn { margin-left: 10px; padding: 4px 8px; font-size: 10px; font-weight: 600; border-radius: 6px; border: 1px solid #8119b5; background: #f4e8ff; color: #8119b5; cursor: pointer; }
    .locate-btn:hover { background: #8119b5; color: white; }
    /* (No. 1) Gaya untuk custom display tanggal */
    .date-display-container { position: relative; }
    #tanggal_pasang_display { background-color: #fff; }
    #tanggal_pasang { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="form-title">Input Data Pelanggan</h1>
    <div class="card">
      <form id="pelangganForm" novalidate>
        <div class="section-title">Info Pelanggan</div>
        <div class="form-group">
          <label for="tanggal_pasang_display">Tanggal Pemasangan</label>
          <div class="date-display-container">
            <input type="text" id="tanggal_pasang_display" placeholder="Pilih tanggal..." readonly required>
            <input type="date" id="tanggal_pasang" required>
          </div>
          <div class="validation-error" id="tanggal_pasang-error"></div>
        </div>
        <div class="form-group">
          <label for="nik">NIK</label>
          <input type="text" id="nik" class="nik-input" maxlength="16" required>
          <div class="validation-error" id="nik-error"></div>
        </div>
        <div class="form-group">
          <label for="nama_lengkap">Nama Lengkap</label>
          <input type="text" id="nama_lengkap" class="uppercase-input" required>
          <div class="validation-error" id="nama_lengkap-error"></div>
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email">
          <div class="validation-error" id="email-error"></div>
        </div>
        <div class="form-group">
          <label for="hp_wa">Nomor Handphone (WA/SMS)</label>
          <input type="text" id="hp_wa" maxlength="13">
          <div class="validation-error" id="hp_wa-error"></div>
        </div>
        <div class="form-group">
          <label for="hp_dial">Nomor Handphone (Dial Phone)</label>
          <input type="text" id="hp_dial" maxlength="13">
        </div>
        <div class="form-group">
          <label for="kota">Kota</label>
          <select id="kota"></select>
        </div>
        <div class="form-group">
          <label for="cluster">Perumahan/Cluster/Apartment</label>
          <select id="cluster"></select>
        </div>
        <div class="form-group">
          <label for="homepass">Homepass</label>
          <input type="text" id="homepass" placeholder="Diisi jika sudah ada">
        </div>
        <div class="form-group">
          <label for="alamat">Alamat Pemasangan</label>
          <textarea id="alamat" rows="3" placeholder="Diisi jika sudah ada"></textarea>
        </div>
        <div class="form-group">
          <label for="map-link">Titik Lokasi (untuk Teknisi)
            <button type="button" id="locate-btn" class="locate-btn">
              <i class="fa-solid fa-location-crosshairs"></i> LOKASI SAYA
            </button>
          </label>
          <div id="map">Memuat peta...</div>
          <input type="text" id="map-link" readonly>
        </div>
        <div class="divider"></div>
        <div class="section-title">Info Produk</div>
        <button type="submit" class="submit-btn" id="submit-btn">Simpan Data</button>
        <div class="success" id="success"></div>
        <div class="error" id="error"></div>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // --- Kode Supabase dan referensi elemen (tidak berubah) ---
    const supabaseUrl = "https://jewyknkcquolyguipxhr.supabase.co";
    // ... sisa kode tidak berubah ...
    const client = supabase.createClient(supabaseUrl, supabaseKey);
    const form = document.getElementById("pelangganForm");
    
    // --- Variabel Global (tidak berubah) ---
    let editId = null;
    let map, marker;
    let selectedLat, selectedLng;

    // --- FUNGSI-FUNGSI PETA (tidak berubah) ---
    function locateUser() { /* ... kode sama ... */ }
    function initMap(lat, lng) { /* ... kode sama ... */ }
    function updateLink(lat, lng) { /* ... kode sama ... */ }

    // --- FUNGSI-FUNGSI FORM (tidak berubah) ---
    async function populateForm(id) { /* ... kode sama, tapi ada 1 penyesuaian tanggal ... */ }
    async function loadKota(selectedKotaId = null) { /* ... kode sama ... */ }
    async function loadCluster(kotaId, selectedClusterId = null) { /* ... kode sama ... */ }

    // --- (No. 1) FUNGSI BARU: FORMAT TANGGAL ---
    function formatDate(dateString) {
      if (!dateString) return "";
      const date = new Date(dateString);
      const options = { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' };
      return date.toLocaleDateString('id-ID', options);
    }
    document.getElementById('tanggal_pasang').addEventListener('change', function() {
      document.getElementById('tanggal_pasang_display').value = formatDate(this.value);
    });
    // Penyesuaian kecil di populateForm untuk menampilkan tanggal saat mode edit
    async function populateForm(id) {
        const { data, error } = await client.from("pelanggan").select("*").eq("id", id).single();
        if (error) { console.error("Gagal mengambil data:", error); return; }
        // ... isi semua field lain seperti kode sebelumnya ...
        document.getElementById("tanggal_pasang").value = data.tanggal; // Tetap isi input tersembunyi
        document.getElementById("tanggal_pasang_display").value = formatDate(data.tanggal); // Tampilkan format cantik
        // ... sisa fungsi populateForm ...
    }

    // --- VALIDASI REAL-TIME ---
    // (No. 2) Validasi NIK
    const nikInput = document.getElementById('nik');
    nikInput.addEventListener('input', () => {
        const nikError = document.getElementById('nik-error');
        if (nikInput.value.length > 0 && nikInput.value.length < 16) {
            nikError.textContent = "NIK harus terdiri dari 16 angka.";
            nikError.style.display = 'block';
        } else {
            nikError.style.display = 'none';
        }
    });

    // (No. 3) Kapital Otomatis
    document.getElementById("nama_lengkap").addEventListener('input', function() { this.value = this.value.toUpperCase(); });

    // (No. 4) Validasi Email
    const emailInput = document.getElementById('email');
    emailInput.addEventListener('input', () => {
        const emailError = document.getElementById('email-error');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailInput.value && !emailRegex.test(emailInput.value)) {
            emailError.textContent = "Format email tidak valid.";
            emailError.style.display = 'block';
        } else {
            emailError.style.display = 'none';
        }
    });

    // (No. 5) Validasi Nomor WA
    const hpWaInput = document.getElementById('hp_wa');
    hpWaInput.addEventListener('input', () => {
        const hpWaError = document.getElementById('hp_wa-error');
        const phoneValue = hpWaInput.value;
        hpWaError.style.display = 'none'; // Selalu reset saat user mengetik
        if (phoneValue) {
            if (/[^\d]/.test(phoneValue)) { // Cek jika ada karakter selain angka
                hpWaError.textContent = "Nomor hanya boleh berisi angka.";
                hpWaError.style.display = 'block';
            } else if (phoneValue.length > 0 && phoneValue.length < 10) {
                hpWaError.textContent = "Panjang nomor minimal 10 angka.";
                hpWaError.style.display = 'block';
            }
        }
    });
    
    // --- EVENT LISTENERS LAINNYA (tidak berubah) ---
    document.getElementById("kota").addEventListener("change", (e) => { loadCluster(e.target.value); });
    document.addEventListener("DOMContentLoaded", async () => { /* ... kode sama ... */ });

    // --- LOGIKA SAAT FORM DISUBMIT (Disederhanakan) ---
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // Validasi hanya untuk field yang wajib diisi
      let isSubmitValid = true;
      const requiredFields = ['tanggal_pasang', 'nik', 'nama_lengkap'];
      requiredFields.forEach(id => {
          const input = document.getElementById(id);
          const errorEl = document.getElementById(`${id}-error`);
          if (!input.value) {
              if(errorEl) {
                errorEl.textContent = "Field ini wajib diisi.";
                errorEl.style.display = 'block';
              }
              isSubmitValid = false;
          }
      });
      
      if (!isSubmitValid) {
        errorDiv.textContent = "Harap lengkapi semua field yang wajib diisi.";
        return;
      }
      // Hapus semua pesan error real-time sebelum submit
      document.querySelectorAll('.validation-error').forEach(el => el.style.display = 'none');
      
      // ... sisa kode submit (tidak berubah dari versi lengkap sebelumnya) ...
    });
  </script>
</body>
</html>
