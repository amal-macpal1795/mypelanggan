<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title id="page-title">Input Data Pelanggan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/b6fe4d3ab8.js" crossorigin="anonymous"></script>
  <style>
    body {
      margin:0; 
      font-family:'Poppins',sans-serif; 
      background:#fafafa; 
      display:flex; 
      justify-content:center; 
      padding:20px;
    }
    .container {
      width:100%; 
      max-width:500px;
      /* (No. 7) Padding sekarang di container karena card dihilangkan */
      padding: 20px; 
    }
    h1 {
      font-size:22px; 
      font-weight:600; 
      margin-bottom:20px; 
      color:#333; 
      text-align:center;
    }
    /* (No. 7) Desain .card dihilangkan */
    .card {
       /* Kosong */
    }
    .section-title {
      font-size:16px; 
      font-weight:600; 
      margin-bottom:12px; 
      color:#222;
    }
    .form-group {
      margin-bottom:14px;
    }
    /* (No. 1) Ukuran font label diperkecil */
    label {
      font-size:13px; 
      font-weight:500; 
      color:#333; 
      display:block; 
      margin-bottom:6px;
    }
    /* (No. 1 & 6) Ukuran font input dan dropdown diperkecil */
    input, select, textarea {
      width:100%; 
      padding:12px; 
      border-radius:10px; 
      border:1px solid #ddd; 
      font-size:13px; 
      font-family:'Poppins',sans-serif; 
      outline:none; 
      transition:border 0.2s;
      box-sizing: border-box;
    }
    /* (No. 2) Gaya khusus untuk input NIK */
    .nik-input {
      font-family: 'OCR A Extended', 'SF Mono', 'Courier New', monospace;
      font-weight: 600;
      letter-spacing: 1.5px;
      font-size: 15px;
    }
    /* (No. 3) Gaya untuk membuat input menjadi kapital */
    .uppercase-input {
      text-transform: uppercase;
    }
    input:focus, select:focus, textarea:focus {
      border-color:#8119b5;
    }
    .divider { border-top:1px solid #e5e5e5; margin:20px 0; }
    .submit-btn {
      width:100%; padding:14px; background:#8119b5; color:#fff;
      border:none; border-radius:12px; font-size:15px; font-weight:500;
      cursor:pointer; transition:background 0.2s;
    }
    .submit-btn:hover { background: #550a7a; }
    .success, .error { font-size:14px; margin-top:10px; text-align:center; }
    .success { color:green; }
    .error { color:red; }

    /* Gaya untuk pesan validasi di bawah input */
    .validation-error {
      color: #d92d20; /* Merah */
      font-size: 11px;
      font-weight: 500;
      margin-top: 4px;
      display: none; /* Sembunyi by default */
    }

    #map { height: 300px; width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid #ddd; }
    .locate-btn {
      margin-left: 10px; padding: 4px 8px; font-size: 10px; font-weight: 600;
      border-radius: 6px; border: 1px solid #8119b5; background: #f4e8ff;
      color: #8119b5; cursor: pointer;
    }
    .locate-btn:hover { background: #8119b5; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="form-title">Input Data Pelanggan</h1>
    <div class="card">
      <form id="pelangganForm" novalidate>
        <div class="section-title">Info Pelanggan</div>
        <div class="form-group">
          <label for="tanggal_pasang">Tanggal Pemasangan</label>
          <input type="date" id="tanggal_pasang" required>
        </div>
        <div class="form-group">
          <label for="nik">NIK</label>
          <input type="number" id="nik" class="nik-input" required>
          <div class="validation-error" id="nik-error"></div>
        </div>
        <div class="form-group">
          <label for="nama_lengkap">Nama Lengkap</label>
          <input type="text" id="nama_lengkap" class="uppercase-input" required>
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email">
          <div class="validation-error" id="email-error"></div>
        </div>
        <div class="form-group">
          <label for="hp_wa">Nomor Handphone (WA/SMS)</label>
          <input type="tel" id="hp_wa">
          <div class="validation-error" id="hp_wa-error"></div>
        </div>
        <div class="form-group">
          <label for="hp_dial">Nomor Handphone (Dial Phone)</label>
          <input type="tel" id="hp_dial">
        </div>
        <div class="form-group">
          <label for="kota">Kota</label>
          <select id="kota"></select>
        </div>
        <div class="form-group">
          <label for="cluster">Perumahan/Cluster/Apartment</label>
          <select id="cluster"></select>
        </div>
        <div class="form-group">
          <label for="homepass">Homepass</label>
          <input type="text" id="homepass" placeholder="Diisi jika sudah ada">
        </div>
        <div class="form-group">
          <label for="alamat">Alamat Pemasangan</label>
          <textarea id="alamat" rows="3" placeholder="Diisi jika sudah ada"></textarea>
        </div>
        <div class="form-group">
          <label for="map-link">Titik Lokasi (untuk Teknisi)
            <button type="button" id="locate-btn" class="locate-btn">
              <i class="fa-solid fa-location-crosshairs"></i> LOKASI SAYA
            </button>
          </label>
          <div id="map">Memuat peta...</div>
          <input type="text" id="map-link" readonly>
        </div>
        
        <div class="divider"></div>
        <div class="section-title">Info Produk</div>
        <div class="form-group">
          <label for="paket_internet">Paket Internet</label>
          <select id="paket_internet">
            <option>(107) Jet20 Mbps</option>
            <option>(146) Plus Value30 Mbps</option>
            </select>
        </div>
        <button type="submit" class="submit-btn" id="submit-btn">Simpan Data</button>
        <div class="success" id="success"></div>
        <div class="error" id="error"></div>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // --- Kode Supabase dan referensi elemen (tidak berubah) ---
    const supabaseUrl = "https://jewyknkcquolyguipxhr.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impld3lrbmtjcXVvbHlndWlweGhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNjA2MzQsImV4cCI6MjA3MzczNjYzNH0.WX8a-wqR5mtKrULGcmd2JrgsDktM-wBYTT7zpC-v6Vw";
    const client = supabase.createClient(supabaseUrl, supabaseKey);
    const form = document.getElementById("pelangganForm");
    // ... Referensi elemen lainnya (tidak berubah) ...

    // --- Variabel Global (tidak berubah) ---
    let editId = null;
    let map, marker;
    let selectedLat, selectedLng;

    // --- FUNGSI-FUNGSI PETA (tidak berubah) ---
    function locateUser() { /* ... kode sama ... */ }
    function initMap(lat, lng) { /* ... kode sama ... */ }
    function updateLink(lat, lng) { /* ... kode sama ... */ }

    // --- FUNGSI-FUNGSI FORM (tidak berubah) ---
    async function populateForm(id) { /* ... kode sama ... */ }
    async function loadKota(selectedKotaId = null) { /* ... kode sama ... */ }
    async function loadCluster(kotaId, selectedClusterId = null) { /* ... kode sama ... */ }

    // --- EVENT LISTENERS LAMA (tidak berubah) ---
    document.getElementById("kota").addEventListener("change", (e) => {
        loadCluster(e.target.value);
    });
    
    // --- (No. 3) FUNGSI BARU: KAPITAL OTOMATIS UNTUK NAMA ---
    document.getElementById("nama_lengkap").addEventListener('input', function() {
      this.value = this.value.toUpperCase();
    });

    // --- (No. 2, 4, 5) FUNGSI BARU: VALIDASI FORM ---
    function validateForm() {
      let isValid = true;
      // Sembunyikan semua error lama
      document.querySelectorAll('.validation-error').forEach(el => el.style.display = 'none');

      // 2. Validasi NIK
      const nikInput = document.getElementById('nik');
      const nikError = document.getElementById('nik-error');
      if (nikInput.value.length !== 16) {
        nikError.textContent = "NIK harus terdiri dari 16 angka.";
        nikError.style.display = 'block';
        isValid = false;
      }

      // 4. Validasi Email
      const emailInput = document.getElementById('email');
      const emailError = document.getElementById('email-error');
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (emailInput.value && !emailRegex.test(emailInput.value)) {
        emailError.textContent = "Format email tidak valid (contoh: user@google.com).";
        emailError.style.display = 'block';
        isValid = false;
      }

      // 5. Validasi Nomor WA
      const hpWaInput = document.getElementById('hp_wa');
      const hpWaError = document.getElementById('hp_wa-error');
      const phoneValue = hpWaInput.value;
      if (phoneValue) { // Hanya validasi jika diisi
        if (phoneValue.includes('+') || phoneValue.includes('-')) {
          hpWaError.textContent = "Nomor tidak boleh mengandung '+' atau '-'.";
          hpWaError.style.display = 'block';
          isValid = false;
        } else if (phoneValue.length < 10 || phoneValue.length > 13) {
          hpWaError.textContent = "Panjang nomor harus antara 10 hingga 13 angka.";
          hpWaError.style.display = 'block';
          isValid = false;
        }
      }
      
      return isValid;
    }

    // --- LOGIKA UTAMA SAAT HALAMAN DIMUAT (tidak berubah) ---
    document.addEventListener("DOMContentLoaded", async () => { /* ... kode sama ... */ });

    // --- LOGIKA SAAT FORM DISUBMIT (DITAMBAH VALIDASI) ---
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // Jalankan validasi sebelum mengirim
      if (!validateForm()) {
        // Tampilkan error utama jika ada field yang tidak valid
        const errorDiv = document.getElementById("error");
        errorDiv.textContent = "Harap perbaiki isian yang salah sebelum menyimpan.";
        return; // Hentikan proses submit
      }

      // ... sisa kode submit (tidak berubah) ...
    });
  </script>
</body>
</html>
